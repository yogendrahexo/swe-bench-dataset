[EXPERIMENT]: Rethink Matching routines
This is another experiment, and also a biggie. It's a rethink of matching as part of #5124.

This will need some tidying to get it into a state that it's reviewable, but given the scale of it - I think I shouldn't take it much further without getting some of it merged.

It's mostly additions for now, so I now need to strip out the things that we can get rid of as a result. Opening PR for testing and in particular for coverage.


Hints:
This is far too big, I'll divide it up into pieces before merging. I think other things need to come first.

Created at: 2023-09-05T18:41:30Z
Version: 2.2
